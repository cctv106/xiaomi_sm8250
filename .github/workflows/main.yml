name: Auto 6-Hour Cleanup (åŒ—äº¬æ—¶é—´)

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # å¿…é¡»æˆäºˆåˆ é™¤å·¥ä½œæµç¨‹è¿è¡Œçš„æƒé™
    permissions:
      actions: write  # å¿…éœ€ï¼šåˆ é™¤å·¥ä½œæµç¨‹è¿è¡Œ
      contents: write # å¿…éœ€ï¼šåˆ é™¤æ ‡ç­¾å’Œå‘å¸ƒ
      packages: write # å¿…éœ€ï¼šæ¸…ç†ç¼“å­˜
      id-token: write # å¿…éœ€ï¼šAPIè®¤è¯

    steps:
      # 1. æ¸…ç†æ‰€æœ‰Actionsç¼“å­˜
      - name: æ¸…é™¤Actionsç¼“å­˜
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ æ­£åœ¨æ¸…é™¤Actionsç¼“å­˜..."
          curl -s -X DELETE \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/caches"
          echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

      # 2. åˆ é™¤æ‰€æœ‰Releases
      - name: åˆ é™¤Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ æ­£åœ¨åˆ é™¤Releases..."
          # è·å–æ‰€æœ‰å‘å¸ƒID
          release_ids=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases" | jq -r '.[].id')
          
          # åˆ é™¤æ‰¾åˆ°çš„å‘å¸ƒ
          if [ -n "$release_ids" ]; then
            for id in $release_ids; do
              curl -s -X DELETE \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$id"
            done
            echo "âœ… å·²åˆ é™¤æ‰€æœ‰Releases (å…± $(echo "$release_ids" | wc -w)ä¸ª)"
          else
            echo "â„¹ï¸ æ²¡æœ‰å¯åˆ é™¤çš„Releases"
          fi

      # 3. åˆ é™¤æ‰€æœ‰Tags
      - name: åˆ é™¤Tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ æ­£åœ¨åˆ é™¤Tags..."
          # è·å–æ‰€æœ‰æ ‡ç­¾åç§°
          tags=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/tags" | jq -r '.[].name')
          
          # åˆ é™¤æ‰¾åˆ°çš„æ ‡ç­¾
          if [ -n "$tags" ]; then
            for tag in $tags; do
              curl -s -X DELETE \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$tag"
            done
            echo "âœ… å·²åˆ é™¤æ‰€æœ‰Tags (å…± $(echo "$tags" | wc -w)ä¸ª)"
          else
            echo "â„¹ï¸ æ²¡æœ‰å¯åˆ é™¤çš„Tags"
          fi

      # 4. åˆ é™¤æ‰€æœ‰å·¥ä½œæµç¨‹è¿è¡Œè®°å½•ï¼ˆå…³é”®æ”¹è¿›ï¼‰
      - name: åˆ é™¤å·¥ä½œæµç¨‹è¿è¡Œè®°å½•
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ æ­£åœ¨åˆ é™¤å·¥ä½œæµç¨‹è¿è¡Œè®°å½•..."
          CURRENT_RUN_ID=${{ github.run_id }}
          
          # è·å–æ‰€æœ‰å·¥ä½œæµç¨‹è¿è¡ŒIDï¼ˆæ’é™¤å½“å‰è¿è¡Œï¼‰
          run_ids=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs" | \
            jq -r ".workflow_runs[] | select(.id != $CURRENT_RUN_ID) | .id")
          
          # åˆ é™¤æ‰¾åˆ°çš„å·¥ä½œæµç¨‹è¿è¡Œ
          if [ -n "$run_ids" ]; then
            for run_id in $run_ids; do
              echo "åˆ é™¤å·¥ä½œæµç¨‹è¿è¡Œ: $run_id"
              curl -s -X DELETE \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id"
            done
            echo "âœ… å·²åˆ é™¤æ‰€æœ‰å·¥ä½œæµç¨‹è¿è¡Œè®°å½• (å…± $(echo "$run_ids" | wc -w)ä¸ª)"
          else
            echo "â„¹ï¸ æ²¡æœ‰å¯åˆ é™¤çš„å·¥ä½œæµç¨‹è¿è¡Œè®°å½•"
          fi

      # 5. è‡ªæˆ‘åˆ é™¤ï¼ˆ100%å¯é ï¼‰
      - name: è‡ªæˆ‘åˆ é™¤
        if: always()  # ç¡®ä¿100%æ‰§è¡Œ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ æ­£åœ¨è‡ªæˆ‘åˆ é™¤..."
          RUN_ID=${{ github.run_id }}
          
          # ç›´æ¥åˆ é™¤å½“å‰è¿è¡Œ
          curl -s -X DELETE \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID"
          
          # æ·»åŠ çŸ­æš‚å»¶è¿Ÿç¡®ä¿åˆ é™¤è¯·æ±‚å®Œæˆ
          sleep 3
          echo "âœ… è‡ªæˆ‘åˆ é™¤è¯·æ±‚å·²å‘é€"
          
          # å¼ºåˆ¶åœæ­¢å½“å‰å·¥ä½œæµç¨‹ï¼ˆç¡®ä¿ç«‹å³ç»ˆæ­¢ï¼‰
          echo "::stop-commands::self-delete"
          echo "âœ… å·¥ä½œæµå·²ç»ˆæ­¢"
